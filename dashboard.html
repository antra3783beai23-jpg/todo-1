<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dashboard - Todo App</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <h1>Your Tasks</h1>
    <div id="userInfo"></div>

    <form id="addForm">
      <input name="title" placeholder="New task title" required />
      <button type="submit">Add</button>
    </form>

    <ul id="taskList"></ul>

    <button id="logout">Logout</button>
  </div>

  <script>
    async function load() {
      try {
        const meRes = await fetch('/api/me');
        if (!meRes.ok) return window.location = '/';
        const me = await meRes.json();
        document.getElementById('userInfo').textContent = 'Logged in as: ' + me.username;

        const res = await fetch('/api/tasks');
        if (!res.ok) {
          document.getElementById('taskList').innerHTML = '<li>Unable to load tasks</li>';
          return;
        }
        const tasks = await res.json();
        renderTasks(tasks);
      } catch (err) {
        console.error('Load error', err);
        document.getElementById('taskList').innerHTML = '<li>Error loading tasks</li>';
      }
    }

    function renderTasks(tasks) {
      const ul = document.getElementById('taskList');
      ul.innerHTML = '';
      if (!tasks || tasks.length === 0) {
        ul.innerHTML = '<li>No tasks yet</li>';
        return;
      }

      tasks.forEach(t => {
        const li = document.createElement('li');

        const titleSpan = document.createElement('span');
        titleSpan.textContent = `${t.title} (${t.status})`;
        titleSpan.style.flex = '1';

        const toggleBtn = document.createElement('button');
        toggleBtn.textContent = t.status === 'done' ? 'Mark Pending' : 'Mark Done';
        toggleBtn.dataset.id = t.id;
        toggleBtn.className = 'toggle';

        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.dataset.id = t.id;
        delBtn.className = 'del';

        li.appendChild(titleSpan);
        li.appendChild(toggleBtn);
        li.appendChild(delBtn);
        ul.appendChild(li);
      });
    }

    document.getElementById('addForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const title = fd.get('title').trim();
      if (!title) return;
      try {
        const res = await fetch('/api/tasks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title })
        });
        if (res.ok) {
          e.target.reset();
          await load();
        } else {
          const data = await res.json().catch(() => ({}));
          alert(data.error || 'Failed to add task');
        }
      } catch (err) {
        console.error('Add task error', err);
        alert('Failed to add task');
      }
    });

    document.getElementById('taskList').addEventListener('click', async (e) => {
      const target = e.target;
      if (target.matches('.toggle')) {
        const id = target.dataset.id;
        try {
          const tasksRes = await fetch('/api/tasks');
          if (!tasksRes.ok) return alert('Could not fetch tasks to toggle');
          const tasks = await tasksRes.json();
          const t = tasks.find(x => x.id === id);
          if (!t) return alert('Task not found');
          const newStatus = t.status === 'done' ? 'pending' : 'done';
          const putRes = await fetch('/api/tasks/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
          });
          if (!putRes.ok) {
            const data = await putRes.json().catch(() => ({}));
            return alert(data.error || 'Failed to update task');
          }
          await load();
        } catch (err) {
          console.error('Toggle error', err);
          alert('Failed to toggle task');
        }
      }

      if (target.matches('.del')) {
        const id = target.dataset.id;
        if (!confirm('Delete this task?')) return;
        try {
          const delRes = await fetch('/api/tasks/' + id, { method: 'DELETE' });
          if (!delRes.ok) {
            const data = await delRes.json().catch(() => ({}));
            return alert(data.error || 'Failed to delete task');
          }
          await load();
        } catch (err) {
          console.error('Delete error', err);
          alert('Failed to delete task');
        }
      }
    });

    document.getElementById('logout').addEventListener('click', async () => {
      try {
        await fetch('/api/logout', { method: 'POST' });
      } catch (err) {
        console.error('Logout error', err);
      } finally {
        window.location = '/';
      }
    });

    
    load();
  </script>
</body>
</html>
